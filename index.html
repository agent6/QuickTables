<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Multiplication Practice</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.5.1/dist/confetti.browser.min.js"></script>
  <style>
    table { border-collapse: collapse; border-spacing: 0; }
    td { padding: 0; margin: 0; }
  </style>
</head>
<body class="bg-gray-100 min-h-screen">
  <!-- Login View -->
  <div id="loginView" class="flex items-center justify-center h-screen">
    <div class="bg-white p-6 rounded shadow w-80">
      <h2 class="text-xl font-bold mb-4">Choose or Create User</h2>
      <select id="userSelect" class="w-full mb-2 p-2 border rounded"></select>
      <input id="newUserInput" type="text" placeholder="New username" class="w-full mb-2 p-2 border rounded" />
      <button id="addUserBtn" class="w-full mb-4 bg-blue-600 text-white py-2 rounded hover:bg-blue-700">Add User</button>
      <button id="loginBtn" class="w-full bg-green-600 text-white py-2 rounded hover:bg-green-700">Login</button>
    </div>
  </div>

  <!-- Dashboard and Test Views -->
  <div id="appView" class="hidden p-4">
    <div id="dashboard" class="w-full max-w-2xl mx-auto">
      <h1 class="text-2xl font-bold mb-2 text-center">Multiplication Practice Dashboard</h1>
      <div class="mb-3 flex justify-center gap-3">
        <label class="flex items-center space-x-1"><input type="radio" name="timeLimit" value="3" /><span class="text-sm">3 sec</span></label>
        <label class="flex items-center space-x-1"><input type="radio" name="timeLimit" value="6" checked /><span class="text-sm">6 sec</span></label>
        <label class="flex items-center space-x-1"><input type="radio" name="timeLimit" value="12" /><span class="text-sm">12 sec</span></label>
      </div>
      <div class="mb-4 overflow-auto">
        <table id="matrix" class="mx-auto border border-gray-400"></table>
      </div>
      <div class="text-center">
        <button id="startBtn" class="px-4 py-1 bg-blue-600 text-white rounded hover:bg-blue-700 text-sm">Start Test</button>
      </div>
    </div>

    <div id="testView" class="hidden w-full max-w-md mx-auto mt-6">
      <div class="flex justify-between mb-3 text-sm"><div>Total: <span id="totalTimer">90</span>s</div><div>Left: <span id="qTimer">0</span>s</div></div>
      <div id="feedback" class="text-center text-4xl h-12 mb-2"></div>
      <div id="question" class="text-2xl font-bold text-center mb-2"></div>
      <div id="inputDisplay" class="text-xl text-center mb-3">&nbsp;</div>
      <div class="grid grid-cols-3 gap-1">
        <button class="num-btn p-2 bg-white rounded shadow text-sm" data-digit="1">1</button>
        <button class="num-btn p-2 bg-white rounded shadow text-sm" data-digit="2">2</button>
        <button class="num-btn p-2 bg-white rounded shadow text-sm" data-digit="3">3</button>
        <button class="num-btn p-2 bg-white rounded shadow text-sm" data-digit="4">4</button>
        <button class="num-btn p-2 bg-white rounded shadow text-sm" data-digit="5">5</button>
        <button class="num-btn p-2 bg-white rounded shadow text-sm" data-digit="6">6</button>
        <button class="num-btn p-2 bg-white rounded shadow text-sm" data-digit="7">7</button>
        <button class="num-btn p-2 bg-white rounded shadow text-sm" data-digit="8">8</button>
        <button class="num-btn p-2 bg-white rounded shadow text-sm" data-digit="9">9</button>
        <button id="clearBtn" class="col-span-2 p-2 bg-red-200 rounded shadow text-sm">Clear</button>
        <button class="num-btn p-2 bg-white rounded shadow text-sm" data-digit="0">0</button>
      </div>
    </div>
  </div>

  <script>
    const matrixSize = 13;
    let stats = [];
    let current = { a: 0, b: 0 };
    let totalTime = 90, qTime = 0, totalInterval, qInterval, timeLimit = 6;
    let currentInput = '';
    let currentUser = '';
    const usersKey = 'mpUsers';

    // User management
    function loadUsers() {
      return JSON.parse(localStorage.getItem(usersKey) || '[]');
    }
    function saveUsers(list) {
      localStorage.setItem(usersKey, JSON.stringify(list));
    }
    function initUserSelect() {
      const sel = document.getElementById('userSelect');
      sel.innerHTML = '';
      loadUsers().forEach(u => {
        const opt = document.createElement('option');
        opt.value = u;
        opt.textContent = u;
        sel.appendChild(opt);
      });
    }

    // Stats persistence
    function loadStats() {
      const stored = localStorage.getItem('mpStats_' + currentUser);
      if (stored) return JSON.parse(stored);
      return Array.from({ length: matrixSize }, () =>
        Array.from({ length: matrixSize }, () => ({ total: 0, correct: 0, timeSum: 0 }))
      );
    }
    function saveStats() {
      localStorage.setItem('mpStats_' + currentUser, JSON.stringify(stats));
    }

    // Weight calculation
    function computeWeights() {
      const list = []; let totalW = 0;
      for (let i = 0; i < matrixSize; i++) {
        for (let j = 0; j < matrixSize; j++) {
          const base = 1/((i+1)*(j+1));
          const s = stats[i][j];
          const ratio = s.total>0 ? s.correct/s.total : 0;
          const profFactor = Math.max(0.1,1-ratio);
          const w = base*profFactor;
          list.push({i,j,w}); totalW += w;
        }
      }
      return { list, totalW };
    }

    // Dashboard render
    function renderMatrix() {
      const matrixEl = document.getElementById('matrix'); matrixEl.innerHTML = '';
      for (let i=0;i<matrixSize;i++){
        const row=document.createElement('tr');
        for(let j=0;j<matrixSize;j++){
          const s=stats[i][j];
          const cell=document.createElement('td');
          cell.id=`cell-${i}-${j}`;
          cell.className='w-10 h-10 border border-gray-300 p-0 text-xs text-center align-middle';
          // Coloring logic
          let color='bg-white';
          if(s.total>0){
            const errors=s.total-s.correct;
            const errorRate=errors/s.total;
            if(errorRate>=0.25){
              color='bg-gray-300';
            } else if(s.correct>=3){
              const avgTime=s.timeSum/s.correct;
              color=avgTime<=timeLimit/2?'bg-green-300':'bg-yellow-300';
            } else {
              color='bg-yellow-300';
            }
          }
          cell.classList.add(color);
          cell.innerHTML=`${i}×${j}<br>${i*j}`;
          row.appendChild(cell);
        }
        matrixEl.appendChild(row);
      }
    }

    // Timers
    function resetQTimer() {
      clearInterval(qInterval);
      qTime = timeLimit;
      document.getElementById('qTimer').textContent = qTime;
    }
    function startTotalTimer() {
      document.getElementById('totalTimer').textContent = totalTime;
      totalInterval = setInterval(() => {
        totalTime--;
        document.getElementById('totalTimer').textContent = totalTime;
        if (totalTime <= 0) endTest();
      }, 1000);
    }
    function startQTimer() {
      clearInterval(qInterval);
      qInterval = setInterval(() => {
        qTime--;
        document.getElementById('qTimer').textContent = qTime;
        if (qTime <= 0) {
          clearInterval(qInterval);
          handleAnswer(null);
        }
      }, 1000);
    }
    function stopQTimer() {
      clearInterval(qInterval);
    }

    // Next question
    function nextFact(){
      currentInput=''; document.getElementById('inputDisplay').textContent='';
      const {list,totalW}=computeWeights();
      let r=Math.random()*totalW, pick=list[0];
      for(const item of list){
        if(r<item.w){ pick=item; break; }
        r-=item.w;
      }
      current={a:pick.i,b:pick.j};
      document.getElementById('question').textContent=`${current.a} × ${current.b} =`;
      resetQTimer(); startQTimer(); questionStart=Date.now();
    }

    // Handle answer
    let questionStart=0;
    function handleAnswer(input){
      stopQTimer();
      const correctAns=current.a*current.b;
      const s=stats[current.a][current.b];
      s.total++;
      let isCorrect=false;
      if(input===correctAns){
        s.correct++;
        s.timeSum+=(Date.now()-questionStart)/1000;
        isCorrect=true;
      }
      saveStats(); renderMatrix();
      const fb=document.getElementById('feedback');
      fb.textContent=isCorrect?'🎉':'❌';
      if(isCorrect) confetti({particleCount:50,spread:60});
      setTimeout(()=>{ fb.textContent=''; if(totalTime>0) nextFact(); },600);
    }

    // Input handlers
    function submitInput(){ if(!currentInput) return; handleAnswer(parseInt(currentInput)); }
    document.querySelectorAll('.num-btn').forEach(btn=>btn.addEventListener('click',()=>{
      currentInput+=btn.dataset.digit;
      document.getElementById('inputDisplay').textContent=currentInput;
      if(parseInt(currentInput)===current.a*current.b) submitInput();
    }));
    document.getElementById('clearBtn').addEventListener('click',()=>{
      currentInput=''; document.getElementById('inputDisplay').textContent='';
    });
    document.addEventListener('keydown',e=>{
      if(/^[0-9]$/.test(e.key)){
        currentInput+=e.key;
        document.getElementById('inputDisplay').textContent=currentInput;
        if(parseInt(currentInput)===current.a*current.b) submitInput();
      } else if(e.key==='Backspace'){
        currentInput=currentInput.slice(0,-1);
        document.getElementById('inputDisplay').textContent=currentInput;
      }
    });

    // Start/end handlers
    document.getElementById('startBtn').addEventListener('click',()=>{
      document.querySelectorAll('input[name=timeLimit]').forEach(r=>{ if(r.checked) timeLimit=+r.value; });
      totalTime=90; renderMatrix();
      document.getElementById('dashboard').classList.add('hidden');
      document.getElementById('testView').classList.remove('hidden');
      nextFact(); startTotalTimer();
    });
    function endTest(){
      clearInterval(totalInterval);
      stopQTimer();
      document.getElementById('testView').classList.add('hidden');
      renderMatrix();
      document.getElementById('dashboard').classList.remove('hidden');
    }

    // Login logic
    document.getElementById('addUserBtn').addEventListener('click',()=>{
      const name=document.getElementById('newUserInput').value.trim();
      if(!name) return;
      const users=loadUsers();
      if(!users.includes(name)){
        users.push(name);
        saveUsers(users);
        initUserSelect();
      }
      document.getElementById('newUserInput').value='';
    });
    document.getElementById('loginBtn').addEventListener('click',()=>{
      const sel=document.getElementById('userSelect');
      currentUser=sel.value;
      if(!currentUser) return;
      stats=loadStats();
      document.getElementById('loginView').classList.add('hidden');
      document.getElementById('appView').classList.remove('hidden');
      renderMatrix();
    });

    // Init
    initUserSelect();
  </script>
</body>
</html>
